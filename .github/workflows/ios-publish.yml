name: iOS Publish to TestFlight

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "Optional: iOS Build workflow run ID (e.g. 21159937388). Leave blank to auto-pick."
        required: false
        type: string
      artifact_name:
        description: "Artifact name to download"
        required: false
        default: "ios-production-build"
        type: string
      search_limit:
        description: "How many recent successful build runs to scan"
        required: false
        default: "50"
        type: string

jobs:
  publish-testflight:
    runs-on: macos-latest

    permissions:
      actions: read
      contents: read

    steps:
      - name: Resolve build run ID
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          INPUT_RUN_ID: ${{ github.event.inputs.build_run_id }}
          ARTIFACT_NAME: ${{ github.event.inputs.artifact_name }}
          SEARCH_LIMIT: ${{ github.event.inputs.search_limit }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_RUN_ID:-}" ]; then
            echo "Using provided build run id: $INPUT_RUN_ID"
            echo "BUILD_RUN_ID=$INPUT_RUN_ID" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "Auto-picking latest successful ios-build.yml run containing artifact: $ARTIFACT_NAME"

          # 1) Resolve workflow ID by path
          WF_ID=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/workflows" \
            | jq -r '.workflows[] | select(.path==".github/workflows/ios-build.yml") | .id')

          if [ -z "$WF_ID" ]; then
            echo "ERROR: Could not find workflow .github/workflows/ios-build.yml"
            exit 1
          fi

          echo "Resolved workflow ID: $WF_ID"

          # 2) Fetch recent successful runs
          RUN_IDS=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/workflows/$WF_ID/runs?status=success&per_page=$SEARCH_LIMIT" \
            | jq -r '.workflow_runs[].id')

          for RID in $RUN_IDS; do
            ART_ID=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/actions/runs/$RID/artifacts" \
              | jq -r ".artifacts[] | select(.name==\"$ARTIFACT_NAME\") | .id" | head -n 1)

            if [ -n "$ART_ID" ]; then
              echo "Found artifact in run $RID"
              echo "BUILD_RUN_ID=$RID" >> "$GITHUB_ENV"
              echo "ARTIFACT_ID=$ART_ID" >> "$GITHUB_ENV"
              exit 0
            fi
          done

          echo "ERROR: Could not find artifact '$ARTIFACT_NAME' in recent successful runs."
          exit 1

      - name: Download IPA artifact
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ARTIFACT_ID: ${{ env.ARTIFACT_ID }}
        run: |
          set -euo pipefail

          mkdir -p ipa
          ZIP="$RUNNER_TEMP/artifact.zip"

          curl -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/artifacts/$ARTIFACT_ID/zip" \
            -o "$ZIP"

          unzip -q "$ZIP" -d ipa

          IPA_PATH=$(find ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "ERROR: No IPA found in artifact"
            exit 1
          fi

          echo "IPA_PATH=$IPA_PATH" >> "$GITHUB_ENV"
          echo "Using IPA: $IPA_PATH"

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          IPA_PATH: ${{ env.IPA_PATH }}
        run: |
          set -euo pipefail

          KEY_DIR="$HOME/.appstoreconnect/private_keys"
          mkdir -p "$KEY_DIR"

          KEY_PATH="$KEY_DIR/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          printf '%s' "$APP_STORE_CONNECT_API_KEY_CONTENT" | tr -d '\n\r' | base64 --decode > "$KEY_PATH"
          chmod 600 "$KEY_PATH"

          echo "Uploading IPA to TestFlight..."
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Upload IPA artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ios-testflight-upload-${{ github.run_id }}
          path: ${{ env.IPA_PATH }}
          retention-days: 30
