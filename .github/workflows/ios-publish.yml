name: iOS Publish to TestFlight

on:
  workflow_dispatch:

jobs:
  publish-testflight:
    runs-on: macos-latest

    steps:
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-production-build
          path: ipa

      - name: Verify IPA
        run: |
          set -euo pipefail
          ls -la ipa
          IPA_PATH=$(find ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "ERROR: No IPA found"
            exit 1
          fi
          echo "IPA found: $IPA_PATH"

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          set -euo pipefail

          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ] || \
             [ -z "$APP_STORE_CONNECT_API_ISSUER_ID" ] || \
             [ -z "$APP_STORE_CONNECT_API_KEY_CONTENT" ]; then
            echo "ERROR: Missing App Store Connect API credentials"
            exit 1
          fi

          AUTH_KEY_PATH="$RUNNER_TEMP/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8"
          printf '%s' "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$AUTH_KEY_PATH"

          IPA_PATH=$(find ipa -name "*.ipa" | head -n 1)

          echo "Uploading IPA to TestFlight..."
          echo "Size: $(du -h "$IPA_PATH" | cut -f1)"

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

          echo "Upload complete"
