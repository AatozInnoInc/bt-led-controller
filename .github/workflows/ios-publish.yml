name: iOS Publish to TestFlight

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "Optional: iOS Build workflow run ID to pull the IPA from (e.g. 21159937388). Leave blank to use latest successful."
        required: false
        type: string
      artifact_name:
        description: "Artifact name to download from that run"
        required: false
        default: "ios-production-build"
        type: string

jobs:
  publish-testflight:
    runs-on: macos-latest

    permissions:
      actions: read
      contents: read

    steps:
      - name: Resolve build run ID (latest successful if not provided)
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_RUN_ID: ${{ github.event.inputs.build_run_id }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_RUN_ID:-}" ]; then
            echo "Using provided build run id: $INPUT_RUN_ID"
            echo "BUILD_RUN_ID=$INPUT_RUN_ID" >> "$GITHUB_ENV"
            exit 0
          fi

          # Find latest successful run of workflow "iOS Build"
          # (this matches the `name:` at the top of ios-build.yml)
          RUN_ID=$(gh run list \
            --workflow "iOS Build" \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "${RUN_ID:-}" ] || [ "$RUN_ID" = "null" ]; then
            echo "ERROR: Could not find a successful run for workflow 'iOS Build'."
            exit 1
          fi

          echo "Latest successful iOS Build run id: $RUN_ID"
          echo "BUILD_RUN_ID=$RUN_ID" >> "$GITHUB_ENV"

      - name: Download IPA artifact from build run
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          BUILD_RUN_ID: ${{ env.BUILD_RUN_ID }}
          ARTIFACT_NAME: ${{ github.event.inputs.artifact_name }}
        run: |
          set -euo pipefail

          echo "Fetching artifacts for run: $BUILD_RUN_ID"
          echo "Looking for artifact name: $ARTIFACT_NAME"

          ARTIFACT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/runs/$BUILD_RUN_ID/artifacts" \
            --jq ".artifacts[] | select(.name==\"$ARTIFACT_NAME\") | .id" | head -n 1)

          if [ -z "${ARTIFACT_ID:-}" ]; then
            echo "ERROR: Artifact '$ARTIFACT_NAME' not found on run $BUILD_RUN_ID."
            echo "Available artifacts on that run:"
            gh api "/repos/$OWNER/$REPO/actions/runs/$BUILD_RUN_ID/artifacts" \
              --jq '.artifacts[].name'
            exit 1
          fi

          echo "Found artifact id: $ARTIFACT_ID"

          mkdir -p ipa
          ZIP_PATH="$RUNNER_TEMP/artifact.zip"

          echo "Downloading artifact zip..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$OWNER/$REPO/actions/artifacts/$ARTIFACT_ID/zip" \
            > "$ZIP_PATH"

          echo "Unzipping..."
          unzip -q "$ZIP_PATH" -d ipa

          echo "Contents:"
          ls -la ipa

          IPA_PATH="$(find ipa -name '*.ipa' | head -n 1 || true)"
          if [ -z "$IPA_PATH" ]; then
            echo "ERROR: No .ipa found inside downloaded artifact."
            exit 1
          fi

          echo "IPA_PATH=$IPA_PATH" >> "$GITHUB_ENV"
          echo "Using IPA: $IPA_PATH"
          echo "Size: $(du -h "$IPA_PATH" | cut -f1)"

      - name: Upload to TestFlight (App Store Connect API Key)
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }} # base64 of .p8
          IPA_PATH: ${{ env.IPA_PATH }}
        run: |
          set -euo pipefail

          if [ -z "${APP_STORE_CONNECT_API_KEY_ID:-}" ] || \
            [ -z "${APP_STORE_CONNECT_API_ISSUER_ID:-}" ] || \
            [ -z "${APP_STORE_CONNECT_API_KEY_CONTENT:-}" ]; then
            echo "ERROR: Missing App Store Connect API credentials."
            exit 1
          fi

          if [ -z "${IPA_PATH:-}" ] || [ ! -f "$IPA_PATH" ]; then
            echo "ERROR: IPA_PATH missing or file not found: ${IPA_PATH:-}"
            exit 1
          fi

          KEY_DIR="$HOME/.appstoreconnect/private_keys"
          mkdir -p "$KEY_DIR"
          AUTH_KEY_PATH="$KEY_DIR/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"

          # Decode base64 -> PEM .p8 file
          printf '%s' "$APP_STORE_CONNECT_API_KEY_CONTENT" | tr -d '\n\r' | base64 --decode > "$AUTH_KEY_PATH"
          chmod 600 "$AUTH_KEY_PATH"

          # Validate PEM structure (no secret leakage)
          FIRST_LINE="$(head -n 1 "$AUTH_KEY_PATH" || true)"
          LAST_LINE="$(tail -n 1 "$AUTH_KEY_PATH" || true)"
          if [ "$FIRST_LINE" != "-----BEGIN PRIVATE KEY-----" ] || [ "$LAST_LINE" != "-----END PRIVATE KEY-----" ]; then
            echo "ERROR: Decoded AuthKey file is not a valid PEM private key."
            echo "Fix secret APP_STORE_CONNECT_API_KEY_CONTENT: it must be base64 of the *raw .p8 file*."
            exit 1
          fi

          echo "Uploading IPA to TestFlight: $IPA_PATH"
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Upload IPA artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ios-testflight-upload-${{ github.run_id }}
          path: ${{ env.IPA_PATH }}
          retention-days: 30
